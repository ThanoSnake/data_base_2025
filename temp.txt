


Ο trigger new_buyer ενεργοποιείται πριν από κάθε εισαγωγή στον πίνακα buyer_interest_queue και ελέγχει την εγκυρότητα των στοιχείων του αγοραστή και τη δυνατότητα αγοράς εισιτηρίου. Αρχικά, επιβεβαιώνει ότι έχει δηλωθεί είτε συγκεκριμένο εισιτήριο (ticket_id) είτε συνδυασμός εκδήλωσης και κατηγορίας (event_id και category). Αν έχει δηλωθεί visitor_id, επαληθεύεται ότι αντιστοιχεί στο όνομα του αγοραστή. Στην περίπτωση που δηλωθεί ticket_id, ελέγχεται αν ο αγοραστής ήδη κατέχει εισιτήριο για το ίδιο event και αν το εισιτήριο είναι πράγματι διαθέσιμο προς πώληση μέσω του resale_queue. Αν δηλωθεί μόνο event_id, επαληθεύεται και πάλι αν ο επισκέπτης διαθέτει ήδη εισιτήριο για το event. Επιπλέον, ελέγχεται αν έχει καλυφθεί η χωρητικότητα του χώρου (stage), αφού μόνο τότε επιτρέπεται η ένταξη αγοραστών στη λίστα αναμονής μεταπώλησης. Τέλος, γίνεται έλεγχος ότι το αίτημα γίνεται πριν τη λήξη του event και μετά την αγορά του τελευταίου εισιτηρίου, ώστε να διασφαλίζεται χρονική συνέπεια στη διαδικασία αγοράς μεταχειρισμένων εισιτηρίων.
            SET MESSAGE_TEXT = 'You cannot buy a ticket yet';
        END IF; 
    END IF;
END//
DELIMITER ;
